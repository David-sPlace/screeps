{"code":"import * as utils from \"utils/utils\";\r\nimport { TaskStatus } from \"./Task\";\r\nvar CreepTaskQueue = /** @class */ (function () {\r\n    function CreepTaskQueue() {\r\n    }\r\n    CreepTaskQueue.totalCount = function (roomName, taskName) {\r\n        if (taskName === void 0) { taskName = \"\"; }\r\n        return CreepTaskQueue.activeCount(roomName, taskName)\r\n            + CreepTaskQueue.pendingCount(roomName, taskName);\r\n    };\r\n    CreepTaskQueue.pendingCount = function (roomName, taskName) {\r\n        if (taskName === void 0) { taskName = \"\"; }\r\n        var roomMem = Game.rooms[roomName].memory;\r\n        if (taskName == \"\") {\r\n            return roomMem.pendingWorkerRequests.length;\r\n        }\r\n        else {\r\n            var count = 0;\r\n            var tasks = roomMem.pendingWorkerRequests;\r\n            for (var id in tasks) {\r\n                var task = tasks[id];\r\n                if (task.name == taskName)\r\n                    count++;\r\n            }\r\n            return count;\r\n        }\r\n    };\r\n    CreepTaskQueue.activeCount = function (roomName, taskName) {\r\n        if (taskName === void 0) { taskName = \"\"; }\r\n        var roomMem = Game.rooms[roomName].memory;\r\n        return Object.keys(roomMem.activeWorkerRequests).length;\r\n    };\r\n    CreepTaskQueue.addPending = function (request) {\r\n        if (CreepTaskQueue.totalCount(request.roomName, request.name) < request.maxConcurrent) {\r\n            var roomMem = Game.rooms[request.roomName].memory;\r\n            roomMem.pendingWorkerRequests.push(request);\r\n        }\r\n    };\r\n    CreepTaskQueue.start = function (creepName, roomName) {\r\n        var roomMem = Game.rooms[roomName].memory;\r\n        if (roomMem.pendingWorkerRequests.length == 0)\r\n            return;\r\n        var creep = Game.creeps[creepName];\r\n        var mem = creep.memory;\r\n        var validTasks = roomMem.pendingWorkerRequests.filter(function (r) { return r.requiredRole == mem.role; });\r\n        if (validTasks.length == 0) {\r\n            console.log(\"nothing to assign for \" + creepName + \" for role \" + utils.getRoleString(mem.role));\r\n            return;\r\n        }\r\n        var sorted = _.sortByAll(validTasks, ['priority', function (t) { return creep.pos.getRangeTo(Game.getObjectById(validTasks[0].targetID)); }]);\r\n        var debug = \"\";\r\n        for (var key in sorted) {\r\n            var task = sorted[key];\r\n            if (task != undefined)\r\n                debug += task.priority + \", \";\r\n        }\r\n        //console.log(\"Debug: \" + debug);\r\n        for (var key in sorted) {\r\n            if (sorted.hasOwnProperty(key)) {\r\n                var task = sorted[key];\r\n                var nextTask = _.find(roomMem.pendingWorkerRequests, task);\r\n                if (nextTask != undefined) {\r\n                    nextTask.assignedTo = creepName;\r\n                    mem.idle = false;\r\n                    mem.currentTask = nextTask.name;\r\n                    roomMem.activeWorkerRequests[creepName] = nextTask;\r\n                    _.remove(roomMem.pendingWorkerRequests, nextTask);\r\n                    console.log(JSON.stringify(nextTask));\r\n                    nextTask.status = TaskStatus.INIT;\r\n                    break;\r\n                }\r\n                else {\r\n                    console.log(\"ARGH!!!.\");\r\n                }\r\n            }\r\n        }\r\n    };\r\n    // static finish(creepName: string, roomName: string)\r\n    // {\r\n    // \tlet roomMem = Game.rooms[roomName].memory as RoomMemory;\r\n    // \t//let started = roomMem.activeWorkerRequests[creepName].started;\r\n    // \t//if(started) roomMem.activeWorkerTaskCount--;\r\n    // \tdelete roomMem.activeWorkerRequests[creepName];\r\n    // }\r\n    CreepTaskQueue.allActive = function (roomName) {\r\n        var roomMem = Game.rooms[roomName].memory;\r\n        return roomMem.activeWorkerRequests;\r\n    };\r\n    CreepTaskQueue.count = function (roomName) {\r\n    };\r\n    return CreepTaskQueue;\r\n}());\r\nexport { CreepTaskQueue };\r\n//# sourceMappingURL=CreepTaskQueue.js.map","map":{"version":3,"file":"CreepTaskQueue.js","sourceRoot":"","sources":["../src/tasks/CreepTaskQueue.ts"],"names":[],"mappings":"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"}}
