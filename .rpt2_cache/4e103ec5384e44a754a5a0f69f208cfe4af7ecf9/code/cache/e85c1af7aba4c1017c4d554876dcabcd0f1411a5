{"code":"// import { roleHarvester, roleUpgrader } from \"roles/role_harvester\";\r\nimport { UpgradeTask, TaskQueue } from \"queue\";\r\nimport { roleToString, m, errorToString } from \"utils/Utils\";\r\nexport var creeps;\r\nexport var creepCount = 0;\r\nexport var harvesters = [];\r\nexport var upgraders = [];\r\nvar RoomManager = /** @class */ (function () {\r\n    function RoomManager() {\r\n        this.roomTasks = new TaskQueue();\r\n        this.creeps = [];\r\n        this.creepCount = 0;\r\n        //harvesters: Array<Creep> = [];\r\n        //builders: Array<Creep> = [];\r\n        this.builders_per_room = 1;\r\n        this.harvesters_per_room = 1;\r\n        this.upgraders_per_room = 1;\r\n    }\r\n    RoomManager.initRoomMemory = function (room) {\r\n        var rm = m().rooms[room.name];\r\n        rm.controllerBeingUpgraded = false;\r\n    };\r\n    RoomManager.prototype.processExistingTasks = function (room) {\r\n        var runningTasks = this.roomTasks.workingTasks();\r\n        //console.log(`processing ${runningTasks.length} existing tasks`);\r\n        for (var _i = 0, runningTasks_1 = runningTasks; _i < runningTasks_1.length; _i++) {\r\n            var runningTask = runningTasks_1[_i];\r\n            var task = runningTask;\r\n            var assignedCreepName = task.assignedCreepName;\r\n            creeps = room.find(FIND_MY_CREEPS, {\r\n                filter: function (creep) {\r\n                    return creep.name == assignedCreepName;\r\n                }\r\n            });\r\n            var creep = creeps[0];\r\n            //console.log(\"!!!!found \" + creep.name);\r\n            if (runningTask.finished) {\r\n                runningTask.finish(creep, undefined);\r\n                this.roomTasks.finish(runningTask);\r\n            }\r\n            else {\r\n                runningTask.continue(creep, room);\r\n            }\r\n        }\r\n    };\r\n    RoomManager.prototype.processRoomTasks = function (room) {\r\n        this.processExistingTasks(room);\r\n        if (this.roomTasks.any() == false)\r\n            return;\r\n        var idleCreeps = room.find(FIND_MY_CREEPS, {\r\n            filter: function (creep) {\r\n                var mem = creep.memory;\r\n                return mem.idle;\r\n            }\r\n        });\r\n        // console.log(`Found ${idleCreeps.length} idle creeps.`)\r\n        for (var _i = 0, idleCreeps_1 = idleCreeps; _i < idleCreeps_1.length; _i++) {\r\n            var creep = idleCreeps_1[_i];\r\n            this.roomTasks.startNext(creep, undefined);\r\n        }\r\n    };\r\n    RoomManager.prototype.loadRoomTasks = function (room, roomMemory) {\r\n        var controller = room.controller;\r\n        if (controller != null) {\r\n            if (controller.ticksToDowngrade < 20000 &&\r\n                roomMemory.controllerBeingUpgraded == false) {\r\n                var upgradeTask = new UpgradeTask(room, controller);\r\n                this.roomTasks.addItem(upgradeTask, room.name);\r\n            }\r\n        }\r\n        else {\r\n            console.log(\"room controller was null!\");\r\n        }\r\n        //console.log(`Task count: ${this.roomTasks.length()}`)\r\n    };\r\n    RoomManager.prototype.Run = function (room, roomMemory) {\r\n        this.loadCreeps(room);\r\n        this.loadRoomTasks(room, roomMemory);\r\n        //this.spawnMissingHarvesters(room);\r\n        this.spawnMissingUpgraders(room);\r\n        //this.loadCreeps(room);\r\n        //build any missing creeps\r\n        this.processRoomTasks(room);\r\n    };\r\n    RoomManager.prototype.loadCreeps = function (room) {\r\n        //console.log(\"loading creeps\");\r\n        creeps = room.find(FIND_MY_CREEPS);\r\n        creepCount = creeps.length;\r\n        //console.log(\"found \" + creepCount + \" creeps in this room.\");\r\n        // harvesters = room.find(FIND_MY_CREEPS, {\r\n        // \tfilter: (creep: Creep) =>\r\n        // \t{\r\n        // \t\tvar creepMemory = creep.memory as CreepMemory;\r\n        // \t\treturn creepMemory.role === CreepRoles.ROLE_MINER;\r\n        // \t}\r\n        // });\r\n        upgraders = room.find(FIND_MY_CREEPS, {\r\n            filter: function (creep) {\r\n                var creepMemory = creep.memory;\r\n                return creepMemory.role === 12 /* ROLE_UPGRADER */;\r\n            }\r\n        });\r\n    };\r\n    RoomManager.prototype.getSpawns = function (room) {\r\n        return room.find(FIND_MY_STRUCTURES, {\r\n            filter: function (structure) {\r\n                if (structure.structureType == STRUCTURE_SPAWN) {\r\n                    var spawner = structure;\r\n                    return spawner.spawning === null;\r\n                }\r\n                return false;\r\n            }\r\n        });\r\n    };\r\n    RoomManager.prototype.spawnMissingUpgraders = function (room) {\r\n        var _this = this;\r\n        var spawns = this.getSpawns(room);\r\n        var upgradersNeeded = this.upgraders_per_room - upgraders.length;\r\n        if (upgradersNeeded === 0)\r\n            return;\r\n        var upgradersSpawned = 0;\r\n        _.each(spawns, function (spawn) {\r\n            if (upgradersSpawned < upgradersNeeded) {\r\n                var spawner = spawn;\r\n                if (spawner.spawning == undefined && upgradersNeeded > 0) {\r\n                    console.log(\"need to spawn \" + upgradersNeeded + \" upgraders for room \" + room.name);\r\n                }\r\n                if (_this.trySpawnCreep(spawner, [WORK, MOVE, MOVE, CARRY], 12 /* ROLE_UPGRADER */)) {\r\n                    upgradersSpawned++;\r\n                }\r\n            }\r\n        });\r\n    };\r\n    RoomManager.prototype.spawnMissingHarvesters = function (room) {\r\n        var _this = this;\r\n        var spawns = this.getSpawns(room);\r\n        var harvestersNeeded = this.harvesters_per_room - harvesters.length;\r\n        if (harvestersNeeded === 0)\r\n            return;\r\n        var harvestersSpawned = 0;\r\n        if (harvestersNeeded > 0) {\r\n            console.log(\"harvester count: \" + harvesters.length);\r\n            console.log(\"need to spawn \" + harvestersNeeded + \" harvesters for room \" + room.name);\r\n        }\r\n        _.each(spawns, function (spawn) {\r\n            if (harvestersSpawned < harvestersNeeded) {\r\n                var spawner = spawn;\r\n                if (_this.trySpawnCreep(spawner, [WORK, MOVE, MOVE, CARRY], 3 /* ROLE_MINER */)) {\r\n                    harvestersSpawned++;\r\n                }\r\n            }\r\n        });\r\n    };\r\n    RoomManager.prototype.trySpawnCreep = function (spawn, bodyParts, role) {\r\n        var spawned = false;\r\n        if (!spawned) {\r\n            if (this.spawnCreep(spawn, bodyParts, role) === OK) {\r\n                spawned = true;\r\n            }\r\n        }\r\n        return spawned;\r\n    };\r\n    RoomManager.prototype.spawnCreep = function (spawn, bodyParts, role) {\r\n        var uuid = Memory.uuid;\r\n        var creepName = spawn.room.name + \"-\" + roleToString(role) + \"-\" + (uuid + 1);\r\n        var status = spawn.spawnCreep(bodyParts, creepName, { dryRun: true });\r\n        status = _.isString(status) ? OK : status;\r\n        if (status === OK) {\r\n            Memory.uuid = uuid + 1;\r\n            var creepName_1 = spawn.room.name + \"-\" + roleToString(role) + \"-\" + uuid;\r\n            var memory = {\r\n                idle: true,\r\n                moving: false,\r\n                building: false,\r\n                name: creepName_1,\r\n                gathering: false,\r\n                role: role,\r\n                roleString: roleToString(role),\r\n                isUpgradingController: false\r\n            };\r\n            // const properties: any = {\r\n            // \tmemory: memory,\r\n            // }\r\n            console.log(\"Started creating new creep: \" + creepName_1);\r\n            status = spawn.spawnCreep(bodyParts, creepName_1, { memory: memory });\r\n            return _.isString(status) ? OK : status;\r\n        }\r\n        else {\r\n            console.log(\"Coudldn't spawn: \" + errorToString(status));\r\n            // if (Config.ENABLE_DEBUG_MODE && status !== ERR_NOT_ENOUGH_ENERGY)\r\n            // {\r\n            // \tlog.info(\"Failed creating new creep: \" + status);\r\n            // }\r\n            return status;\r\n        }\r\n    };\r\n    return RoomManager;\r\n}());\r\nexport { RoomManager };\r\n//# sourceMappingURL=RoomManager.js.map","map":{"version":3,"file":"RoomManager.js","sourceRoot":"","sources":["src/RoomManager.ts"],"names":[],"mappings":"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"}}
